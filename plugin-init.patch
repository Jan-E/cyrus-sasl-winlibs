From f5ad270e0f6de0015e09ff27c701f47d07520894 Mon Sep 17 00:00:00 2001
From: Anatol Belski <ab@php.net>
Date: Tue, 13 Mar 2018 01:31:45 +0100
Subject: [PATCH] Fix plugin init

---
 plugins/NTMakefile | 56 ++++++++++++++++++++++++----------------------
 1 file changed, 29 insertions(+), 27 deletions(-)

diff --git a/plugins/NTMakefile b/plugins/NTMakefile
index 9930789..3efe770 100644
--- a/plugins/NTMakefile
+++ b/plugins/NTMakefile
@@ -64,48 +64,48 @@ compat_objs = getaddrinfo.obj getnameinfo.obj
 common_sources = plugin_common.c plugin_common.h
 common_objs = plugin_common.obj $(compat_objs)
 
-saslANONYMOUS_sources = anonymous.c $(common_sources)
-saslANONYMOUS_objs = anonymous.obj $(common_objs)
+saslANONYMOUS_sources = anonymous.c anonymous_init.c $(common_sources)
+saslANONYMOUS_objs = anonymous.obj anonymous_init.obj $(common_objs)
 saslANONYMOUS_out = saslANONYMOUS.dll saslANONYMOUS.exp saslANONYMOUS.lib
 
-saslPLAIN_sources = plain.c $(common_sources)
-saslPLAIN_objs = plain.obj $(common_objs)
+saslPLAIN_sources = plain.c plain_init.c $(common_sources)
+saslPLAIN_objs = plain.obj plain_init.obj $(common_objs)
 saslPLAIN_out = saslPLAIN.dll saslPLAIN.exp saslPLAIN.lib
 
-saslCRAMMD5_sources = cram.c $(common_sources)
-saslCRAMMD5_objs = cram.obj $(common_objs)
+saslCRAMMD5_sources = cram.c crammd5_init.c $(common_sources)
+saslCRAMMD5_objs = cram.obj crammd5_init.obj $(common_objs)
 saslCRAMMD5_out = saslCRAMMD5.dll saslCRAMMD5.exp saslCRAMMD5.lib
 
-saslDIGESTMD5_sources = digestmd5.c $(common_sources)
-saslDIGESTMD5_objs = digestmd5.obj $(common_objs)
+saslDIGESTMD5_sources = digestmd5.c digestmd5_init.c $(common_sources)
+saslDIGESTMD5_objs = digestmd5.obj digestmd5_init.obj $(common_objs)
 saslDIGESTMD5_out = saslDIGESTMD5.dll saslDIGESTMD5.exp saslDIGESTMD5.lib
 
-saslLOGIN_sources = login.c $(common_sources)
-saslLOGIN_objs = login.obj $(common_objs)
+saslLOGIN_sources = login.c login_init.c $(common_sources)
+saslLOGIN_objs = login.obj login_init.obj $(common_objs)
 saslLOGIN_out = saslLOGIN.dll saslLOGIN.exp saslLOGIN.lib
 
-saslSCRAM_sources = scram.c $(common_sources)
-saslSCRAM_objs = scram.obj $(common_objs)
+saslSCRAM_sources = scram.c scram_init.c $(common_sources)
+saslSCRAM_objs = scram.obj scram_init.obj $(common_objs)
 saslSCRAM_out = saslSCRAM.dll saslSCRAM.exp saslSCRAM.lib
 
-saslNTLM_sources = ntlm.c $(common_sources)
-saslNTLM_objs = ntlm.obj $(common_objs)
+saslNTLM_sources = ntlm.c ntlm_init.c $(common_sources)
+saslNTLM_objs = ntlm.obj ntlm_init.obj $(common_objs)
 saslNTLM_out = saslNTLM.dll saslNTLM.exp saslNTLM.lib
 
-saslGSSAPI_sources = gssapi.c $(common_sources)
-saslGSSAPI_objs = gssapi.obj $(common_objs)
+saslGSSAPI_sources = gssapi.c gssapiv2_init.c $(common_sources)
+saslGSSAPI_objs = gssapi.obj gssapiv2_init.obj $(common_objs)
 saslGSSAPI_out = saslGSSAPI.dll saslGSSAPI.exp saslGSSAPI.lib
 
-saslSRP_sources = srp.c $(common_sources)
-saslSRP_objs = srp.obj $(common_objs)
+saslSRP_sources = srp.c srp_init.c $(common_sources)
+saslSRP_objs = srp.obj srp_init.obj $(common_objs)
 saslSRP_out = saslSRP.dll saslSRP.exp saslSRP.lib
 
-saslOTP_sources = otp.c $(common_sources)
-saslOTP_objs = otp.obj $(common_objs)
+saslOTP_sources = otp.c otp_init.c $(common_sources)
+saslOTP_objs = otp.obj otp_init.obj $(common_objs)
 saslOTP_out = saslOTP.dll saslOTP.exp saslOTP.lib
 
-saslSQL_sources = sql.c $(common_sources)
-saslSQL_objs = sql.obj $(common_objs)
+saslSQL_sources = sql.c sql_init.c $(common_sources)
+saslSQL_objs = sql.obj sql_init.obj $(common_objs)
 # saslSQL_out is an agregation of all generated files for all SQL plugins
 saslSQL_out = saslSQLITE.dll saslSQLITE.exp saslSQLITE.lib
 
@@ -143,10 +143,12 @@ libsasldb_objs = allockey.obj db_berkeley.obj
 
 CRAM_FLAGS=/DOBSOLETE_CRAM_ATTR=1
 
-DIGEST_FLAGS=/D "WITH_RC4"
+DIGEST_FLAGS=/D "WITH_RC4" /DOBSOLETE_DIGEST_ATTR=1
 
-saslSASLDB_sources = sasldb.c $(libsasldb_sources) $(common_sources)
-saslSASLDB_objs = sasldb.obj $(libsasldb_objs) $(common_objs)
+SCRAM_FLAGS=/DHAVE_SHA256=1
+
+saslSASLDB_sources = sasldb.c sasldb_init.c $(libsasldb_sources) $(common_sources)
+saslSASLDB_objs = sasldb.obj sasldb_init.obj $(libsasldb_objs) $(common_objs)
 saslSASLDB_out = saslSASLDB.dll saslSASLDB.exp saslSASLDB.lib
 
 all_objs = $(saslANONYMOUS_objs) $(saslPLAIN_objs) $(saslCRAMMD5_objs) $(saslDIGESTMD5_objs) $(saslLOGIN_objs) $(saslSCRAM_objs) $(saslNTLM_objs) $(saslGSSAPI_objs) $(saslSRP_objs) $(saslOTP_objs) $(saslSASLDB_objs) $(saslSQL_objs) $(saslLDAPDB_objs)
@@ -159,7 +161,7 @@ DB_FLAGS = /I $(DB_INCLUDE) /I "..\sasldb" /D "LIBSASL_EXPORTS" /D "KEEP_DB_OPEN
 EXTRA_FLAGS = /D TARGET_WIN_SYSTEM=$(TARGET_WIN_SYSTEM) $(EXTRA_FLAGS)
 !ENDIF
 
-EXTRA_FLAGS=$(EXTRA_FLAGS) $(DB_FLAGS) $(OPENSSL_FLAGS) $(GSS_FLAGS) $(SRP_FLAGS) $(SQL_FLAGS) $(DIGEST_FLAGS) $(CRAM_FLAGS) $(LDAP_FLAGS)
+EXTRA_FLAGS=$(EXTRA_FLAGS) $(DB_FLAGS) $(OPENSSL_FLAGS) $(GSS_FLAGS) $(SRP_FLAGS) $(SQL_FLAGS) $(DIGEST_FLAGS) $(CRAM_FLAGS) $(SCRAM_FLAGS) $(LDAP_FLAGS)
 CPPFLAGS = /I "..\win32\include" /I "." /I "..\include" $(EXTRA_FLAGS) /D "WIN32" /D "_WIN32" /D "_WINDOWS" /D "_MBCS" /D "_USRDLL"
 
 OPENSSL_LIBS=/libpath:$(OPENSSL_LIBPATH) libssl.lib libcrypto.lib
@@ -324,7 +326,7 @@ BEGIN
             VALUE "FileDescription", "CMU SASL $(@B) plugin\0"
             VALUE "FileVersion", "$(SASL_VERSION_MAJOR).$(SASL_VERSION_MINOR).$(SASL_VERSION_STEP).0\0"
             VALUE "InternalName", "$(@B)\0"
-            VALUE "LegalCopyright", "Copyright (c) Carnegie Mellon University 2002-2012\0"
+            VALUE "LegalCopyright", "Copyright (c) Carnegie Mellon University 2002-2017\0"
             VALUE "OriginalFilename", "$(@B).dll\0"
             VALUE "ProductName", "Carnegie Mellon University SASL\0"
             VALUE "ProductVersion", "$(SASL_VERSION_MAJOR).$(SASL_VERSION_MINOR).$(SASL_VERSION_STEP)-0"
